

## 一、存储系统

存储系统是指计算机中由存放程序和数据的各种存储设备、控制部件及管理信息调度的设备（硬件）和算法（软件）所组成的系统。

**基本术语**：

- 存储器：存放程序和数据的器件。
- 存储位：存放一个二进制数位的存储单元，是存储器最小的存储单位。
- 存储字：计算机可寻址（作为一个整体存入或取出）的最小信息单位。
- 存储单元：存放一个存储字的若干个记忆单元组成一个存储单元。
- 存储体：大量存储单元的集合组成存储体。
- 存储单元地址：存储单元的编号。
- 字编址：对存储单元按字编址。
- 字节编址：对存储单元按字节编址。
- 寻址：通过地址寻找数据，从对应地址的存储单元中访存数据。

### 1.1 存储器分类

#### 按存储介质分类

- 半导体存储器：用半导体器件组成的存储器。
- 磁表面存储器：用磁性材料做成的存储器。
- 激光存储器：信息以刻痕的形式保存在盘面上，用激光束照射盘面，靠盘面的不同反射率来读出信息。

#### 按存取方式分类

1. 随机存储器（RAM，Random Access Memory）：可随机访问任意存储单元，且存取时间与存储单元的物理位置无关。主要充当高速缓冲存储器和主存储器。
   - 动态随机存储器（DRAM）：只能将数据保持很短的时间。为了保持数据，DRAM 使用电容存储，所以必须隔一段时间刷新（Refresh）一次，如果存储单元没有被刷新，存储的信息就会丢失，关机就会丢失数据。常用于主存储器。
   - 静态随机存储器（SRAM）：所谓的 “静态”，指这种存储器只要保持通电，里面储存的数据就可以恒常保持。相对之下，DRAM 里面储存的数据需要周期性地 Refresh。然而，当电力供应停止（关机）时，储存的数据还是会消失，所以也称为 Volatile Memory（易失性存储器），这与在断电后仍能储存数据的 ROM 或闪存不同的。但是 SRAM 也有它的缺点，即它的集成度较低，功耗较 DRAM 大，相同容量的 DRAM 内存可以设计为较小的体积，但是 SRAM 却需要很大的体积。同样面积的硅片可以做出更大容量的 DRAM，因此 SRAM 显得更贵。常用于高速缓存。
2. 串行访问存储器（SAS）：在存储器中只能按某种顺序来进行存取，存取时间与存储单元的物理位置有关。
   - 顺序存取存储器（SAM）：是完全的串行访问，如：磁带，读写时要待磁带移动到合适位置之后才能顺序读写。由于价格便宜，主要用于数据备份容灾系统。
   - 直接存取存储器（DAM）：是部分的串行访问，如：HHD 机械硬盘，对信息的存取有两步操作。首先，磁头直接移动到目标区域（磁道），然后再从磁道的合适位置开始读写，它介于顺序存取和随机存取之间。主要用于辅助存储器。
3. 只读存储器（ROM）：是一种只能读不能写入的存储器，即预先一次性写入的存储器。通常用来存放固定不变的信息，如微程序控制存储器。

#### 按信息的可保存性分类

- 非永久记忆（易失性）的存储器：掉电后数据消失的存储器，如：半导体读/写存储器 RAM。
- 永久性记忆（非易失性）的存储器：掉电后仍能保存信息的存储器，如：磁性材料做成的存储器以及半导体 ROM。

### 1.2 三层存储结构

存储系统的性能在计算机中具有非常重要的地位，主要因为：

- 冯诺伊曼体系结构是建筑在 “存储程序” 概念的基础上，访存操作约占中央处理器（CPU）时间的 70% 左右。
- 存储管理与组织的好坏影响到整机效率。
- 现代的信息处理，如图像处理、数据库、知识库、语音识别、多媒体等对存储系统的要求很高。

计算机的主存储器（内存）来存放当前正在执行的应用程序及数据，但主存储器不能同时满足存取速度快、存储容量大和成本低的要求，在计算机中必须有速度由慢到快、容量由大到小的多级层次存储器，以最优的控制调度算法和合理的成本，构成具有性能可接受的存储系统，这就是 “缓存-主存-辅存” 三层存储结构。

其中，高速缓冲存储器（Cache）用来改善主存储器与中央处理器的速度匹配问题（主存和 CPU 一直保持了大约一个数量级的差距），高速缓存-主存层级拥有接近于缓存的速度和接近于主存的容量，解决了速度和成本之间的矛盾，主要用于提高 CPU 的访问速度；而辅助存储器（外存）则使用来存放当前不在运行的大量程序及数据，主存-辅存层级拥有接近于主存储器的速度和接近于辅存储器的容量，解决了大容量和低成本的需求，主要用于扩大存储空间。

#### 1.2.1 高速缓冲存储器（Cache）

高速缓存通常为半导体存储器、静态随机存储器（SRAM）和非永久性记忆存储器。高速缓存的提出建立在著名的局部性原理之上，局部性原理表示：程序访问的地址往往集中在存储器逻辑地址空间很小的范围之内。这是因为程序的地址分布本来就是连续的，再加上循环程序流、子程序调用程序流的重复执行，所以程序的地址访问自然就会相对的集中了。在主存和 CPU 之间设置了 Cache 之后，如果当前正在执行的程序和数据存放在 Cache 中，则当程序运行时不必再从主存储器读取指令和数据，访问 Cache 即可。

Cache 的工作原理有三点值得我们注意：

1. 主存和 Cache 都会采用分字块的方式进行管理，Cache 中保存的就是对应的主存字块的一个副本。每一个 Cache 字块都会有一个标记位，用于表示当前字块里存放的是哪一个内存字块的副本。通过这个标准位，CPU 就可以判断出希望访问的内存字块是否已经存在于 Cache 中了。
2. 当 Cache 已经用满，但主存还将新的字块调入 Cache 时，就会执行一次 Cache 字块的替换。这种替换遵守一定的规律，最好使得被替换的字块是下一个时间段内估计最小使用的，这种规则成为替换策略或替换算法，有替换部件实现。
3. 当程序对 Cache 的字块执行写入时，如何保证 Cache 字块和内存字块的一致性。通常的有两种写入方式：一个是先写 Cache 字块，待 Cache 字块被替换出去时再一次性写入内存字块；在一个是在写 Cache 字块的同时也写入内存字块。

#### 1.2.2 主存储器

内存通常为半导体存储器、动态随机存储器（DRAM）和非永久记忆存储器。具有两个非常重要的特性：“可随机访问任意存储单元” 和 “掉电即失去数据”，这些特性均服务于冯诺依曼体系 “存储程序” 的核心理想。

主存储器和 CPU 的连接是由总线来支持的，包括数据总线、地址总线和控制总线。CPU 通过 AR（地址寄存器）& AB（地址总线）、DR（数码寄存器）& DB（数据总线）和主存进行数据传输。若 AR 为 K 位字长，表示 CPU 的寻址宽度，即允许主存包含有 2**K 个可寻址存储单位；若 DR 为 n 位字长，则表示在一个存储周期内，CPU 和主存之间通过总线进行 n 位数据传输。控制总线包括控制数据传输的读（READ）、写（WRITE）和表示存储器功能完成的（READY）的三种控制线。

**CPU 读取主存数据**：当 CPU 从存储器读取一个存储字时，CPU 必须指定该存储字的地址，将该地址送到 AR 再经 AB 送到存储器，同时，CPU 通过控制线发送 READ 信号到存储器。此后，CPU 等到存储器通过控制线发来一个 READY 信号，表示已经完成了数据的读，并将数据经 DB 放到 DR 上了，CPU 再从 DR 取出相应的数据。以此来完成了一个存储器字的读与取。

** CPU 存放数据到主存**：CPU 为了存放一个字到存储器，首先将存储字在存储器中的存放地址通过 AR 经 AB 发送到存储器，并将存储字放到 DR，同时发出一个 WRITE 信号到存储器。此后，CPU 等到接收 READY 信号。存储器会根据 AB 收到的地址来存放 DB 接收到的存储字，然后通过 READY 控制线发送 READY 信号给 CPU 接收。以此完成了一个存储字的存放。

可见，主存和 CPU 之间采用的是异步工作方式，以 READY 信号表示以此访存操作的结束。

![image-20201217194702747](/Users/alburtams/Library/Application Support/typora-user-images/image-20201217194702747.png)



#### 1.2.3 辅助存储器

外存通常为磁表面存储器、串行访问存储器和永久性记忆存储器，有磁盘存储器和古老一些的磁带已经光盘。磁盘存储器有 HDD（Hard Disk Drive）和 HDC（Hard Disk Controller）组成，而当下比较时髦的 SSD（Solid-state Drive）是一种主要以闪存（NAND Flash）作为永久性存储器的计算机存储设备，区别于以机械臂带动磁头转动实现读写操作的磁盘存储器，NAND 或者其他固态存储以电位高低或者相位状态的不同记录 0 和 1。辅存的只要技术指标有：存储密度、存储容量、寻址时间、数据传输率、误码率和价格。

值得注意的是，HDD 的存取时间为毫秒（ms）级别，为主存储器的存取时间为纳秒（ns）级别，两种的速度差别十分大。因此 I/O 系统成为了整个计算机系统的瓶颈，所以为了进一步拉近距离，在主存储器和辅存储器之间也引入了缓存层，即磁盘 Cache。磁盘 Cache 同样基于局部性原理，对数据使用了预读策略。现在的 HDD 通常会带有高速缓存介质，并且通常也为 SRAM 或 DRAM，容量为十几 MB 以上。但又因为 RAM 是易失性存储器，所以为了防止掉电时数据丢失的问题，一些 HDD 还会带有不间断电设备。

## 二 、 虚拟存储器

在早期的计算机系统中，程序员会直接对主存储器的物理地址进行操作，这种编程方式导致了当程序出现寻址错误时有可能会导致整个系统崩溃，当一个进程出现寻址错误时也可能会导致另一个进程崩溃。显然，直接操作主存的物理地址不是一个好的方法。而且，由于不存在分页或分段的存储空间管理手段，所以 CPU 寻址宽度就成为了存储容量的限制，例如：32 位 CPU 只支持 4GB 内存的寻址。这导致了该计算机无法运行存储空间需求大于实际内存容量的应用程序。

为了解决这些问题，现代计算机系统通过操作系统和硬件的结合，把主存储器和辅存储器从逻辑上统一成了一个整体，这就是虚拟存储器，或称为虚拟存储系统。虚拟存储器是硬件异常、硬件地址翻译、主存、磁盘文件和内核软件的完美交互，它为每个进程提供了一个大的、一致的和私有的地址空间。

**虚拟存储器的两大特点**：

- 允许用户程序使用比实际主存空间大得多的空间来访问主存
- 每次访存都要进行虚实地址转换。
  - **物理地址**，即物理主存的地址空间。主存被组织成一个由 M 个连续的、字节大小的单元组成的数组，每字节都有一个唯一的物理地址（Physical Address，PA）。第一个字节的地址为 0，接下来的字节的地址为 1，依此类推。给定这种简单的结构，CPU 访问存储器的最自然的方式就是使用物理地址，即物理寻址。
  - **虚拟地址**，即虚拟存储地址空间，它能够让应用程序误以为自己拥有一块连续可用的 “物理” 地址，但实际上从程序视角所见的都是虚拟地址，而且这些虚拟地址对应的物理主存空间通常可能是碎片的，甚至有部分数据还可能会被暂时储存在外部磁盘设备上，在需要时才进行数据交换。

虚拟存储器的核心思路是根据程序运行时的局部性原理，一个程序运行时，在一小段时间内，只会用到程序和数据的很小一部分，仅把这部分程序和数据装入主存即可，更多的部分可以在需要用到时随时从辅存调入主存。在操作系统和相应硬件的支持下，数据在辅存和主存之间按程序运行的需要自动成批量地完成交换。

**虚拟存储器提供了三个重要的能力**：

1. 它将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式，它高效地使用了主存。
2. 它为每个进程提供了一致的地址空间，从而简化了存储器管理。
3. 它保护了每个进程的地址空间不被其他进程破坏。

**虚拟存储器解决了三个根本需求**：

1. **确保可以运行存储空间需求比实际主存储容量大的应用程序**。
2. **确保可执行程序被装载后占用的内存空间是连续的**。因为 PC 程序计数器是自增的，换句话说就是程序执行必须顺序存放在存储器中，PC 才能够按照程序语句，一条一条的读取指令，不错乱。
3. **确保同时加载多个程序的时候不会造成内存地址冲突**。虽然在生成可执行文件时指令已经有了对应的内存地址，但实际加载的时候，其实没办法保证程序一定就运行在这些内存地址上，因为多个程序同时运行的话，预期的内存地址很可能已经被其他程序占用了。

**NOTE**：虚拟存储器指的是 “主存-辅存” 层次，由软硬件结合实现，而 “缓存-主存” 是由存硬件实现的。

### 2.1 段式虚拟存储管理方式

段式存储管理是一种把主存按段分配的存储管理方式，主存-辅存间信息传送单位是不定长的段。优点是段的分界与程序的自然分界是相对应的。例如：过程、子程序、数据表和阵列等待程序的模块化性质都可以与段对应起来。于是段作为独立的逻辑单位可以被其他程序段调用，这样就形成了段间连接，产生规模较大的程序。这样的特性使得段易于编译、管理、修改和保护，也便于多道程序共享。而缺点是容易在段间留下许多空余的存储空间碎片，且不好收集利用。除此之外，段式存储管理还存在交换性能较低的问题。因为辅存的访问速度比主存慢得多，而每一次交换，我们都需要把一大段连续的内存数据写到硬盘上，导致了当内存交换一个较大的段时，会让机器显得卡顿。

### 2.2 页式虚拟存储管理方式

页式存储管理是一种把主存按页分配的存储管理方式，主存-辅存间信息传送单位是定长的页。对比段而言，因为管理的粒度更细致，所以造成内存页碎片的浪费也会小很多。而缺点也正好相反，由于页不是程序独立模块对应的逻辑实体，所以处理、保护和共享都不及段来得方便。同时也因为页要比段小得多，在 Linux 下通常默认设置为 4KB，所以页在进行交换时，不会出现段交换那般卡顿。所以，页式存储管理方式会更加的受到欢迎，Linux 操作系统采用的就是页式存储管理方式。

















































































